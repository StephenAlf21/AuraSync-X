<!DOCTYPE html>
<html lang="en">
<head>
    <script>
  if (location.protocol !== 'https:') {
    // preserve host, path, query, hash
    location.replace(
      'https://' +
      window.location.host +
      window.location.pathname +
      window.location.search +
      window.location.hash
    );
  }
</script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AuraSync X | Ultimate 3D Music Visualizer</title>
    <!-- Favicon Links -->
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="shortcut icon" href="favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    
    <!-- Tippy.js for Tooltips -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css"/>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/material.css">
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
      body {
        font-family: 'Orbitron', monospace;
        background-color: #1a202c;
      }
      .glow {
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.7);
      }
      .control-panel {
        backdrop-filter: blur(10px);
      }
      .high-contrast {
        filter: contrast(1.5);
      }
      /* Hide default file input */
      #fileInput {
        display: none;
      }
      /* Hide focus outlines but keep them for keyboard users */
      button:focus-visible, input:focus-visible {
        outline: 2px solid #6366f1;
        outline-offset: 2px;
      }
      /* Scrollbar for playlist */
      #playlistContainer::-webkit-scrollbar {
        width: 6px;
      }
      #playlistContainer::-webkit-scrollbar-thumb {
        background-color: rgba(99, 102, 241, 0.7);
        border-radius: 3px;
      }
      /* Tippy.js theme customization */
      .tippy-box[data-theme~='material'] {
        font-family: 'Orbitron', monospace;
        background-color: #2d3748; /* gray-800 */
      }
      .tippy-box[data-theme~='material'][data-placement^='top'] > .tippy-arrow::before {
        border-top-color: #2d3748;
      }
      .tippy-box[data-theme~='material'][data-placement^='bottom'] > .tippy-arrow::before {
        border-bottom-color: #2d3748;
      }
      /* --- FIX: Prevent tooltip overflow on small screens --- */
      .tippy-box {
        max-width: 90vw;
      }
      /* Basic styles for the new alert modal */
      .modal-card {
        background-color: #2d3748; /* gray-800 */
        border-radius: 0.75rem; /* rounded-xl */
        padding: 1.5rem; /* p-6 */
        width: 90%;
        max-width: 500px;
        border: 1px solid #4a5568; /* border-gray-700 */
      }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col lg:flex-row">
  
  <!-- Main Content Area with padding transition -->
  <div id="mainContent" class="flex-1 overflow-y-auto transition-all duration-300 ease-in-out scroll-pb-20">
    <div class="container mx-auto px-2 sm:px-4 py-6">
      <header class="flex flex-col md:flex-row justify-between items-center mb-6">
        <div class="flex items-center mb-4 md:mb-0">
          <div class="bg-indigo-600 w-10 h-10 rounded-lg flex items-center justify-center mr-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
          </div>
          <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-500 bg-clip-text text-transparent">AuraSync X</h1>
        </div>
        <div class="flex flex-wrap justify-center sm:justify-end items-center gap-2">
           <!-- Playlist toggle button now here -->
           <button id="togglePlaylistBtn" data-tippy-content="Toggle Playlist" class="p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors" aria-label="Toggle Playlist" aria-expanded="false" aria-controls="playlistPanel">
              <svg id="playlistToggleIcon" class="w-6 h-6 stroke-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
           </button>
          <button id="accessibilityBtn" data-tippy-content="Accessibility" class="p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors" aria-label="Accessibility settings">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2">
               <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>
          <button id="helpBtn" data-tippy-content="Help" class="p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors" aria-label="Help">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </button>
          <!-- Version Number -->
          <span id="appVersion" class="ml-3 text-gray-400 text-sm"></span>
        </div>
      </header>

      <main class="flex flex-col lg:flex-row gap-6">
        <!-- === UPDATED VISUALIZER & CONTROLS WRAPPER === -->
        <section class="flex-1 flex flex-col rounded-xl overflow-hidden border border-gray-700 glow">
          <!-- Visualizer Area -->
          <div class="flex">
            <div id="visualizer" class="flex-1 bg-black aspect-[16/9]"></div>
            <!-- === FIX: Removed h-full to allow flexbox to control height reliably === -->
            <canvas id="spectrumCanvas" class="hidden sm:block w-1/5 bg-black"></canvas>
          </div>
          
          <!-- Player Controls Area -->
          <div class="bg-gray-800 bg-opacity-80 p-4 flex items-center border-t border-gray-700">
            <div class="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16 flex items-center justify-center" aria-hidden="true">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z" />
              </svg>
            </div>
            <div class="ml-4 flex-1 min-w-0">
              <h3 class="font-bold truncate" id="trackTitle">No Track Loaded</h3>
              <p class="text-sm text-gray-400" id="trackArtist">Add songs to the playlist to begin</p>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-4 flex-1 ml-4">
              <button id="prevBtn" data-tippy-content="Previous" class="p-2 rounded-full bg-gray-700 hover:bg-indigo-500 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed" aria-label="Previous track" disabled>
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.168V5.832a1 1 0 00-1.555-.832L3.11 9.168a1 1 0 000 1.664l5.335 4.001zM11 5v10a1 1 0 001.555.832l5.335-4.168a1 1 0 000-1.664L12.555 4.168A1 1 0 0011 5z"></path></svg>
              </button>
              <button id="playPauseBtn" data-tippy-content="Play / Pause" class="p-3 rounded-full bg-indigo-600 hover:bg-indigo-500 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed" aria-label="Play or pause" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </button>
               <button id="nextBtn" data-tippy-content="Next" class="p-2 rounded-full bg-gray-700 hover:bg-indigo-500 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed" aria-label="Next track" disabled>
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M11.555 5.168A1 1 0 0010 5.832v8.336a1 1 0 001.555.832l5.335-4.168a1 1 0 000-1.664l-5.335-4.168zM4 5v10a1 1 0 001.555.832l5.335-4.168a1 1 0 000-1.664L5.555 4.168A1 1 0 004 5z"></path></svg>
              </button>
              <span id="currentTime" class="text-sm w-12 text-right">0:00</span>
              <div id="progressWrapper" class="flex-1 cursor-pointer" aria-label="Track progress">
                <div class="h-1 bg-gray-700 rounded-full overflow-hidden">
                  <div id="progressBar" class="h-full bg-indigo-500 w-0 transition-all duration-100 ease-linear"></div>
                </div>
              </div>
              <span id="durationTime" class="text-sm w-12 text-left">0:00</span>
            </div>
          </div>
        </section>

        <aside class="w-full md:w-64 lg:w-80 bg-gray-800 bg-opacity-50 rounded-xl p-6 control-panel border border-gray-700">
          <h2 class="text-xl font-bold mb-4 text-indigo-400">Visualization Controls</h2>
          <div class="mb-6">
            <h3 class="font-semibold mb-2">Visualization Type</h3>
            <div class="grid grid-cols-2 gap-2">
              <button class="viz-type p-3 rounded-lg bg-gray-700 hover:bg-indigo-600 transition-colors" data-viz="particles" aria-pressed="true">Particles</button>
              <button class="viz-type p-3 rounded-lg bg-gray-700 hover:bg-indigo-600 transition-colors" data-viz="waves" aria-pressed="false">Waves</button>
              <button class="viz-type p-3 rounded-lg bg-gray-700 hover:bg-indigo-600 transition-colors" data-viz="sphere" aria-pressed="false">Sphere</button>
              <button class="viz-type p-3 rounded-lg bg-gray-700 hover:bg-indigo-600 transition-colors" data-viz="tunnel" aria-pressed="false">Tunnel</button>
            </div>
          </div>
          <div class="mb-6">
            <h3 class="font-semibold mb-2">Color Scheme</h3>
            <div class="flex space-x-2">
              <button class="color-scheme w-10 h-10 rounded-full bg-gradient-to-r from-blue-400 to-teal-400" data-scheme="blue" aria-pressed="true"></button>
              <button class="color-scheme w-10 h-10 rounded-full bg-gradient-to-r from-purple-400 to-pink-400" data-scheme="purple" aria-pressed="false"></button>
              <button class="color-scheme w-10 h-10 rounded-full bg-gradient-to-r from-yellow-400 to-red-400" data-scheme="fire" aria-pressed="false"></button>
              <button class="color-scheme w-10 h-10 rounded-full bg-gradient-to-r from-green-400 to-emerald-400" data-scheme="nature" aria-pressed="false"></button>
            </div>
          </div>
          <div class="mb-6" data-tippy-content="Adjusts visual reaction to music">
            <h3 class="font-semibold mb-2">Sensitivity</h3>
            <input type="range" id="sensitivity" min="1" max="10" value="5" class="w-full accent-indigo-500" aria-valuemin="1" aria-valuemax="10" aria-valuenow="5" />
          </div>
          <div class="mb-6" data-tippy-content="Controls background animation speed">
            <h3 class="font-semibold mb-2">Animation Speed</h3>
            <input type="range" id="speed" min="1" max="10" value="5" class="w-full accent-indigo-500" aria-valuemin="1" aria-valuemax="10" aria-valuenow="5" />
          </div>
          <div class="mb-6" data-tippy-content="Adjust Volume">
            <h3 class="font-semibold mb-2">Volume</h3>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" class="w-full accent-indigo-500" aria-label="Volume" />
          </div>
          <div class="mb-6">
            <h3 class="font-semibold mb-2">Decibel Meter</h3>
            <div class="w-full bg-gray-700 rounded overflow-hidden h-2">
              <div id="decibelBar" class="h-full bg-green-400 w-0 transition-all duration-100 ease-linear"></div>
            </div>
            <span id="decibelValue" class="text-sm text-gray-300 mt-1 block">–∞ dB</span>
          </div>
        </aside>
      </main>
    </div>
  </div>

  <!-- Playlist Panel (Sidebar) -->
  <aside id="playlistPanel" class="fixed top-0 right-0 h-full w-full sm:w-80 bg-gray-800 transform transition-transform duration-300 ease-in-out translate-x-full flex flex-col border-l border-gray-700 z-40 pb-12">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
          <h2 class="text-xl font-bold text-indigo-400">Playlist</h2>
          <button id="closePlaylistBtn" class="p-2 rounded-lg hover:bg-gray-700" aria-label="Close Playlist">
              <svg class="w-6 h-6 stroke-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
      </div>
      <!-- Layer-selector (acts like pagination) -->
      <div id="playlistTabs" class="flex justify-around gap-1 px-4 pt-2">
        <button data-layer="local"
                class="playlist-tab flex-1 py-1.5 text-xs sm:text-sm rounded-lg bg-indigo-600 font-semibold">
          Local
        </button>
        <button data-layer="remote"
                class="playlist-tab flex-1 py-1.5 text-xs sm:text-sm rounded-lg bg-gray-700 hover:bg-indigo-500">
          URL
        </button>
        <button data-layer="radio"
                class="playlist-tab flex-1 py-1.5 text-xs sm:text-sm rounded-lg bg-gray-700 hover:bg-indigo-500">
          Radio
        </button>
      </div>
      <div id="playlistContainer" class="flex-1 overflow-y-auto p-4 space-y-2">
          <!-- Playlist items will be injected here -->
      </div>
      <div class="p-4 border-t border-gray-700">
          <input type="file" id="fileInput" accept=".mp3" multiple />
          <label for="fileInput" data-tippy-content="Add MP3 files from your computer" class="w-full py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition-colors flex items-center justify-center cursor-pointer" aria-label="Add new track">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Add Songs
          </label>
          <div class="mt-4 flex space-x-2">
            <input
              id="urlInput"
              type="url"
              placeholder="https://example.com/song.mp3"
              class="flex-1 px-3 py-2 rounded-lg bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
              aria-label="Song URL"
            />
            <button
              id="addUrlBtn"
              class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition-colors text-sm"
              aria-label="Add song by URL"
            >Add</button>
          </div>
          <!-- --- Internet-radio search --- -->
          <div class="mt-4 flex space-x-2">
            <input
              id="radioSearchInput"
              type="text"
              placeholder="Search radio (e.g., Cat Country)"
              class="flex-1 px-3 py-2 rounded-lg bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
              aria-label="Radio station name"
            />
            <button
              id="radioSearchBtn"
              class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition-colors text-sm"
              aria-label="Add internet radio station"
            >
              Search
            </button>
          </div>
          <!-- === NEW: Recommended Radio Stations === -->
          <div id="recommendedStations" class="mt-4">
            <h4 class="text-sm text-indigo-400 mb-2 font-semibold">Open Access Radio Stations</h4>
            <ul class="space-y-1">
              <!-- JS will populate this -->
            </ul>
          </div>
      </div>
  </aside>

  <!-- === ALERT MODAL (for URL validation etc.) === -->
  <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-md flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="alertTitle">
    <div class="modal-card">
      <div class="flex justify-between items-center mb-4">
        <h2 id="alertTitle" class="text-xl font-bold text-yellow-400">Notice</h2>
        <button id="closeAlert" class="p-2 rounded-full hover:bg-gray-700 transition-colors" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <p id="alertMessage" class="text-gray-200">Please enter a direct link to an audio file (e.g., .mp3, .ogg, .wav).</p>
    </div>
  </div>

  <!-- === ACCESSIBILITY MODAL === -->
  <div id="accessibilityModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-md flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="accessibilityTitle">
    <div class="modal-card">
      <div class="flex justify-between items-center mb-6">
        <h2 id="accessibilityTitle" class="text-2xl font-bold text-indigo-400">Accessibility Settings</h2>
        <button id="closeAccessibility" class="p-2 rounded-full hover:bg-gray-700 transition-colors" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="space-y-6">
        <div>
          <h3 class="font-semibold mb-2 text-lg">Visual Accessibility</h3>
          <div class="flex items-center space-x-2">
            <input type="checkbox" id="highContrast" class="accent-indigo-500" />
            <label for="highContrast" class="text-gray-200">High Contrast Mode</label>
          </div>
        </div>
        <hr class="border-gray-700" />
        <div>
          <h3 class="font-semibold mb-2 text-lg">Animation Sensitivity</h3>
          <input type="range" id="animationSensitivity" min="1" max="5" value="3" class="w-full accent-indigo-500" />
        </div>
        <hr class="border-gray-700" />
        <div>
          <h3 class="font-semibold mb-2 text-lg">Keyboard Shortcuts</h3>
          <ul class="grid grid-cols-2 gap-4 text-sm">
            <li><kbd class="px-2 py-1 bg-gray-700 rounded">Space</kbd> Play/Pause</li>
            <li><kbd class="px-2 py-1 bg-gray-700 rounded">→</kbd> Next Track</li>
            <li><kbd class="px-2 py-1 bg-gray-700 rounded">←</kbd> Previous Track</li>
            <li><kbd class="px-2 py-1 bg-gray-700 rounded">+ / −</kbd> Volume</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- === HELP MODAL === -->
  <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-md flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="modal-card">
        <div class="flex justify-between items-center mb-6">
            <h2 id="helpTitle" class="text-2xl font-bold text-indigo-400">How to Use AuraSync X</h2>
            <button id="closeHelp" class="p-2 rounded-full hover:bg-gray-700 transition-colors" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="space-y-4 text-gray-200">
            <p>1. Click the list icon <svg xmlns="http://www.w3.org/2000/svg" class="inline h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg> in the header to open the playlist.</p>
            <p>2. Use the 'Local', 'URL', and 'Radio' tabs to switch between playlists.</p>
            <p>3. Add songs using the buttons at the bottom of the playlist panel.</p>
            <p>4. Click any item in the playlist to start the music and the visualization.</p>
            <p>5. Use the control panel to customize the visualization type, colors, and sensitivity.</p>
            <p>6. Use the player controls or keyboard shortcuts (Space, Arrows) to manage playback.</p>
        </div>
    </div>
  </div>

  <!-- Copyright Footer -->
  <footer class="fixed bottom-0 left-0 w-full bg-gray-900 bg-opacity-75 text-center py-2 z-50">
    <span id="appCopyright" class="text-gray-400 text-xs"></span>
  </footer>

  <script>
    // --- GLOBAL STATE & VARIABLES ---
    const APP_VERSION = '1.6.0'; // Version with UI layout fix
    let currentLayer = 'local'; // default page

    const defaultTracks = [
      { name: "A Palestinian Protest Anthem", url: "assets/song1.mp3", artist: "zombies21", type: "local" },
      { name: "Common Flame of Deutschland", url: "assets/song2.mp3", artist: "zombies21", type: "local" },
      { name: "Arbeiter Canada v2", url: "assets/song3.mp3", artist: "zombies21", type: "local" }
    ];

    // === UPDATED: Recommended Stations List with corrected HTTPS streams ===
    const recommendedStations = [
      {
        name: "CBC Radio One (Halifax)",
        url: "https://cbc-r1-hfx.akacast.akamaistream.net/7/255/451501/v1/rc-connect.akacast.akamaistream.net/CBC_R1_HFX_P",
        country: "Canada"
      },
      {
        name: "CBC Music",
        url: "https://cbc-r2-tor.akacast.akamaistream.net/7/383/451502/v1/rc-connect.akacast.akamaistream.net/CBC_R2_TOR_P",
        country: "Canada"
      },
      {
        name: "Radio Swiss Jazz",
        url: "https://stream.srg-ssr.ch/m/rsj/aacp_96",
        country: "Switzerland"
      },
      {
        name: "BBC World Service",
        url: "https://stream.live.vc.bbcmedia.co.uk/bbc_world_service",
        country: "UK"
      },
      {
        name: "SomaFM: Groove Salad",
        url: "https://ice4.somafm.com/groovesalad-128-mp3",
        country: "USA"
      },
      {
        name: "NPR News",
        url: "https://npr-ice.streamguys1.com/live.mp3",
        country: "USA"
      }
    ];

    let playlist = defaultTracks.map(t => ({
      file: null, url: t.url, name: t.name, artist: t.artist, isDefault: true, type: t.type
    }));

    let scene, camera, renderer, audioElement;
    let particles, waves, sphere, tunnel;
    let currentVisualization = 'particles';
    let currentColorScheme = 'blue';
    let isPlaying = false;
    let animationId, spectrumAnimationId;
    let currentTrackIndex = -1;
    let animationSpeed = 5;
    let sensitivity = 5;
    let timeData;

    // --- Persistent Audio API State ---
    let audioContext, analyser, source;
    let bufferLength, dataArray;

    // --- DOM ELEMENTS ---
    const mainContent = document.getElementById('mainContent');
    const playlistPanel = document.getElementById('playlistPanel');
    const playlistContainer = document.getElementById('playlistContainer');
    const togglePlaylistBtn = document.getElementById('togglePlaylistBtn');
    const closePlaylistBtn = document.getElementById('closePlaylistBtn');
    const playlistToggleIcon = document.getElementById('playlistToggleIcon');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const fileInput = document.getElementById('fileInput');
    let currentTimeEl, durationEl, progressWrapper, progressBar, volumeSlider;
    let specCanvas, specCtx, decibelBar, decibelValue;


    // --- ICONS ---
    const playIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
    const pauseIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;

    // --- COLOR SCHEMES ---
    const colorSchemes = {
      blue: [0x4facfe, 0x00f2fe], purple: [0x9d50bb, 0x6e48aa],
      fire: [0xff9a9e, 0xfad0c4], nature: [0x0ba360, 0x3cba92]
    };
    
    // --- CANVAS RESIZE FUNCTION ---
    function resizeSpectrumCanvas() {
      if (specCanvas) {
        const dpr = window.devicePixelRatio || 1;
        specCanvas.width  = specCanvas.clientWidth * dpr;
        specCanvas.height = specCanvas.clientHeight * dpr;
        specCtx.scale(dpr, dpr);
      }
    }

    // --- INITIALIZATION FUNCTIONS ---
    function initThreeJS() {
      const container = document.getElementById('visualizer');
      if (!container) return;
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      const width = container.clientWidth; const height = container.clientHeight;
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);
      camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
      camera.position.z = 30;
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(width, height);
      container.appendChild(renderer.domElement);
      
      window.addEventListener('resize', () => {
        const newWidth = container.clientWidth; const newHeight = container.clientHeight;
        camera.aspect = newWidth / newHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(newWidth, newHeight);
        resizeSpectrumCanvas();
      });

      initParticles(); initWaves(); initSphere(); initTunnel();
      scene.add(particles);
    }
    function initParticles() {
      const particleCount = 2000;
      const positions = new Float32Array(particleCount * 3);
      const colors = new Float32Array(particleCount * 3);
      const baseColor = new THREE.Color(colorSchemes[currentColorScheme][0]);
      for (let i = 0; i < particleCount; i++) {
        positions[i * 3] = (Math.random() - 0.5) * 100;
        positions[i * 3 + 1] = (Math.random() - 0.5) * 100;
        positions[i * 3 + 2] = (Math.random() - 0.5) * 100;
        colors[i * 3] = baseColor.r; colors[i * 3 + 1] = baseColor.g; colors[i * 3 + 2] = baseColor.b;
      }
      const geometry = new THREE.BufferGeometry();
      geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
      const material = new THREE.PointsMaterial({ size: 0.5, vertexColors: true, transparent: true, opacity: 0.8 });
      particles = new THREE.Points(geometry, material);
    }
    function initWaves() {
        const geometry = new THREE.PlaneGeometry(100, 100, 64, 64);
        const material = new THREE.MeshBasicMaterial({ color: colorSchemes[currentColorScheme][0], wireframe: true, transparent: true, opacity: 0.7 });
        waves = new THREE.Mesh(geometry, material);
        waves.rotation.x = -Math.PI / 2;
    }
    function initSphere() {
        const geometry = new THREE.SphereGeometry(15, 64, 64);
        const material = new THREE.MeshBasicMaterial({ color: colorSchemes[currentColorScheme][0], wireframe: true, transparent: true, opacity: 0.7 });
        sphere = new THREE.Mesh(geometry, material);
        sphere.geometry.setAttribute('initialPosition', sphere.geometry.attributes.position.clone());
    }
    function initTunnel() {
        const geometry = new THREE.CylinderGeometry(10, 10, 200, 64, 32, true);
        const material = new THREE.MeshBasicMaterial({ color: colorSchemes[currentColorScheme][0], wireframe: true, transparent: true, opacity: 0.7, side: THREE.BackSide });
        tunnel = new THREE.Mesh(geometry, material);
        tunnel.rotation.x = Math.PI / 2;
    }
    
    // --- Function to unlock audio context on user gesture ---
    function unlockAudio() {
        if (audioContext && audioContext.state === 'suspended') {
            audioContext.resume();
        }
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.connect(audioContext.destination);
            analyser.fftSize = 256;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            timeData = new Float32Array(analyser.fftSize);
        }
    }

    // --- REVISED: initAudio now uses the persistent audio context ---
    function initAudio(track) {
      if (animationId) cancelAnimationFrame(animationId);
      if (spectrumAnimationId) cancelAnimationFrame(spectrumAnimationId);
      
      if (audioElement) { 
        audioElement.pause(); 
        audioElement.src = ''; 
        if (source) {
            source.disconnect(); // Disconnect previous source
        }
      }
      audioElement = new Audio();
      
      if (track.file) {
        audioElement.src = URL.createObjectURL(track.file);
      } else {
        audioElement.crossOrigin = "anonymous"; 
        audioElement.src = track.url;
      }

      audioElement.addEventListener('play', () => { 
        isPlaying = true; 
        playPauseBtn.innerHTML = pauseIconSVG;
        playPauseBtn.setAttribute('aria-label','Pause');
        animate(); 
        drawSpectrum();
      });
      audioElement.addEventListener('pause', () => { 
          isPlaying = false; 
          playPauseBtn.innerHTML = playIconSVG;
          playPauseBtn.setAttribute('aria-label','Play');
      });

      // Create a new source for the new audio element and connect to the *global* analyser
      source = audioContext.createMediaElementSource(audioElement);
      source.connect(analyser);

      audioElement.addEventListener('loadedmetadata', setDuration);
      audioElement.addEventListener('timeupdate', updateProgressBar);
      audioElement.addEventListener('ended', () => {
          playNextTrack();
      });
    }

    // --- PLAYLIST & PLAYBACK LOGIC ---
    function handleFiles(files) {
        Array.from(files).forEach(file => {
          if (file.type === 'audio/mpeg') {
            playlist.push({ 
              file, 
              name: file.name.replace('.mp3',''), 
              artist: 'Local File', 
              isDefault: false,
              type: 'local'
            });
          }
        });
        if (currentTrackIndex === -1 && playlist.length) {
          playTrack(0);
        }
        renderPlaylist();
        updateButtons();
    }
    
    function removeTrack(index) {
      const wasPlaying = isPlaying;
      const removedCurrent = index === currentTrackIndex;
      
      playlist.splice(index, 1);

      if (removedCurrent) {
        if (audioElement) audioElement.pause();
        if (playlist.length > 0) {
            // Play the next available track
            playTrack(index % playlist.length);
        } else {
            // No tracks left
            currentTrackIndex = -1;
            document.getElementById('trackTitle').textContent = 'No Track Loaded';
            document.getElementById('trackArtist').textContent = 'Add songs to the playlist to begin';
            // Ensure player state is fully reset
            isPlaying = false;
            playPauseBtn.innerHTML = playIconSVG;
            playPauseBtn.setAttribute('aria-label','Play');
            updateProgressBar();
        }
      } else if (index < currentTrackIndex) {
          currentTrackIndex--;
      }

      renderPlaylist();
      updateButtons();
    }

    // === REVISED: playTrack function with better error handling ===
    function playTrack(index) {
        if (index < 0 || index >= playlist.length) return;
        
        unlockAudio(); // Ensure audio context is ready on any attempt to play

        currentTrackIndex = index;
        const track = playlist[index];
        document.getElementById('trackTitle').textContent = track.name;
        document.getElementById('trackArtist').textContent = track.artist;
        
        initAudio(track); // Sets up the new audio source and listeners
        
        const playPromise = audioElement.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error("Playback error for track:", track.name, error);
                // The 'pause' event listener in initAudio will handle the UI update.
                // We just need to show an alert for user-facing errors.
                if (error.name === 'NotSupportedError') {
                    showAlert(`Could not play "${track.name}". The stream might be offline or in an unsupported format.`, 'Playback Error');
                } else if (error.name !== 'AbortError') {
                    // This handles the case where autoplay is blocked initially.
                    showAlert("Playback was blocked. Click the main play button to start.", "Playback Notice");
                }
            });
        }
        
        renderPlaylist();
        updateButtons();
    }

    function playNextTrack() {
        if (!playlist.length) return;
        playTrack((currentTrackIndex + 1) % playlist.length);
    }
    function playPrevTrack() {
        if (!playlist.length) return;
        playTrack((currentTrackIndex - 1 + playlist.length) % playlist.length);
    }
    
    function togglePlayPause() {
      if (!audioElement) return;
      
      unlockAudio(); // Ensure audio context is ready

      if (audioElement.paused) {
        audioElement.play();
      } else {
        audioElement.pause();
      }
    }

    // --- UI & VISUALIZATION LOGIC ---
    function renderPlaylist() {
        playlistContainer.innerHTML = '';
        
        const visible = playlist.filter(t => t.type === currentLayer);

        if (!visible.length) {
            playlistContainer.innerHTML = `<p class="text-gray-400 text-center">No songs in this list.</p>`;
            return;
        }

        visible.forEach((track) => {
            const realIndex = playlist.indexOf(track);
            const isActive = realIndex === currentTrackIndex;
            const item = document.createElement('div');
            item.className = `p-3 rounded-lg cursor-pointer flex items-center transition-colors
                              ${isActive ? 'bg-indigo-600' : 'bg-gray-700 hover:bg-gray-600'}`;
            item.innerHTML = `
              <svg class="w-5 h-5 mr-3 ${isActive ? 'text-white' : 'text-indigo-400'}"
                   fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2
                         1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2
                         1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
              </svg>
              <div class="flex-1 min-w-0">
                <div class="font-bold truncate">${track.name}</div>
                <div class="text-sm text-gray-400 truncate">${track.artist}</div>
              </div>
              <button class="remove-btn ml-2 p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors"
                      aria-label="Remove track">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>`;
            item.addEventListener('click', e => {
              if (e.target.closest('.remove-btn')) return;
              playTrack(realIndex);
            });
            item.querySelector('.remove-btn').addEventListener('click', e => {
              e.stopPropagation();
              removeTrack(realIndex);
            });
            playlistContainer.appendChild(item);
        });
    }

    function renderRecommendedStations() {
      const container = document.querySelector("#recommendedStations ul");
      container.innerHTML = "";
      recommendedStations.forEach(station => {
        const li = document.createElement("li");
        li.className = "flex items-center justify-between bg-gray-700 p-2 rounded hover:bg-indigo-600 cursor-pointer transition-colors";
        li.innerHTML = `
          <span>
            <span class="font-semibold">${station.name}</span>
            <span class="text-xs text-gray-400 ml-2">${station.country}</span>
          </span>
          <button class="add-radio-btn px-2 py-1 rounded bg-indigo-500 hover:bg-indigo-400 text-xs font-semibold">Add</button>
        `;
        li.querySelector(".add-radio-btn").addEventListener("click", (e) => {
          playlist.push({
            file: null,
            url: station.url,
            name: station.name,
            artist: station.country,
            isDefault: false,
            type: "radio"
          });
          renderPlaylist();
          updateButtons();
          document.querySelector('.playlist-tab[data-layer="radio"]').click();
        });
        container.appendChild(li);
      });
    }

    function updateButtons() {
        const hasTracks = !!playlist.length;
        playPauseBtn.disabled = !hasTracks;
        nextBtn.disabled = !hasTracks;
        prevBtn.disabled = !hasTracks;
    }

    // === HELPER FUNCTIONS FOR PLAYER CONTROLS ===
    function formatTime(sec) {
      if (!isFinite(sec)) return 'Live';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }
    
    function setDuration() {
      if (audioElement) {
        durationEl.textContent = formatTime(audioElement.duration);
      }
    }
    
    function seek(e) {
      if (!audioElement || !audioElement.duration || !isFinite(audioElement.duration)) return;
      const rect = progressWrapper.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const newTime = (clickX / rect.width) * audioElement.duration;
      audioElement.currentTime = newTime;
      updateProgressBar();
    }

    function updateProgressBar() {
        if (!audioElement) {
            progressBar.style.width = '0%';
            currentTimeEl.textContent = '0:00';
            durationEl.textContent = '0:00';
            return;
        }
        if (!isFinite(audioElement.duration)) { 
            progressBar.style.width = '100%';
            currentTimeEl.textContent = 'Live';
            return; 
        }
        const pct = (audioElement.currentTime / audioElement.duration) * 100;
        progressBar.style.width = pct + '%';
        currentTimeEl.textContent = formatTime(audioElement.currentTime);
    }
    
    function animate() {
      if (!isPlaying) return;
      animationId = requestAnimationFrame(animate);
      if (!analyser) return;
      
      analyser.getByteFrequencyData(dataArray);
      updateDecibelMeter();

      let sum = 0;
      for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
      const avgFrequency = sum / bufferLength;
      const speed = animationSpeed / 500;
      switch (currentVisualization) {
          case 'particles': updateParticles(avgFrequency, speed); break;
          case 'waves': updateWaves(speed); break;
          case 'sphere': updateSphere(speed); break;
          case 'tunnel': updateTunnel(speed); break;
      }
      camera.position.x = Math.sin(Date.now() * 0.0001) * 5;
      camera.position.y = Math.cos(Date.now() * 0.0001) * 5;
      camera.lookAt(scene.position);
      renderer.render(scene, camera);
    }

    function drawSpectrum() {
      if (!isPlaying) return;
      spectrumAnimationId = requestAnimationFrame(drawSpectrum);
      
      const unscaledWidth = specCanvas.clientWidth;
      const unscaledHeight = specCanvas.clientHeight;

      specCtx.clearRect(0, 0, unscaledWidth, unscaledHeight);
      specCtx.fillStyle = '#000';
      specCtx.fillRect(0, 0, unscaledWidth, unscaledHeight);

      const barWidth = unscaledWidth / bufferLength;
      let x = 0;
      for (let i = 0; i < bufferLength; i++) {
        const v = dataArray[i] / 255;
        const barHeight = v * unscaledHeight;
        const hue = (i / bufferLength) * 360;
        specCtx.fillStyle = `hsl(${hue}, 100%, 60%)`;
        specCtx.fillRect(x, unscaledHeight - barHeight, barWidth, barHeight);
        x += barWidth;
      }
    }
    
    function updateDecibelMeter() {
      analyser.getFloatTimeDomainData(timeData);
      let sumSquares = 0.0;
      for (const amplitude of timeData) { sumSquares += amplitude * amplitude; }
      const rms = Math.sqrt(sumSquares / timeData.length);
      const db = rms > 0 ? 20 * Math.log10(rms) : -100;
      const displayDb = Math.max(db, -100).toFixed(1);
      decibelValue.textContent = `${displayDb} dB`;
      const pct = Math.min(rms * 100, 100);
      decibelBar.style.width = `${pct}%`;
    }

    function updateParticles(avgFrequency, speed) {
        particles.rotation.y += speed;
        const scale = 1 + (avgFrequency / 128) * (sensitivity / 10);
        particles.scale.set(scale, scale, scale);
    }
    function updateWaves(speed) {
        const positions = waves.geometry.attributes.position.array;
        const currentSensitivity = sensitivity / 5;
        const time = Date.now() * 0.005;
        for (let i = 0; i < positions.length; i += 3) {
            const x = positions[i]; const z = positions[i + 2];
            const dataIndex = Math.floor(Math.abs(x + z) % bufferLength);
            positions[i + 1] = Math.sin((x + z) * 0.1 + time) * (dataArray[dataIndex] / 255) * 10 * currentSensitivity;
        }
        waves.geometry.attributes.position.needsUpdate = true;
        waves.rotation.y += speed / 2;
    }
    function updateSphere(speed) {
        const positions = sphere.geometry.attributes.position.array;
        const initialPositions = sphere.geometry.attributes.initialPosition.array;
        const currentSensitivity = sensitivity / 5;
        for (let i = 0; i < positions.length; i += 3) {
            const dataIndex = Math.floor((i / 3) % bufferLength);
            const scale = 1 + (dataArray[dataIndex] / 255) * 0.5 * currentSensitivity;
            positions[i] = initialPositions[i] * scale;
            positions[i + 1] = initialPositions[i + 1] * scale;
            positions[i + 2] = initialPositions[i + 2] * scale;
        }
        sphere.geometry.attributes.position.needsUpdate = true;
        sphere.rotation.x += speed;
        sphere.rotation.y += speed;
    }
    function updateTunnel(speed) {
        tunnel.position.z = (tunnel.position.z - speed * 50) % 100;
        const positions = tunnel.geometry.attributes.position.array;
        const currentSensitivity = sensitivity / 5;
        for (let i = 0; i < positions.length; i += 3) {
            const angle = Math.atan2(positions[i], positions[i+1]);
            const dataIndex = Math.floor(((angle + Math.PI) / (2 * Math.PI)) * bufferLength) % bufferLength;
            const radius = 10 + (dataArray[dataIndex] / 255) * 10 * currentSensitivity;
            positions[i] = Math.cos(angle) * radius;
            positions[i+1] = Math.sin(angle) * radius;
        }
        tunnel.geometry.attributes.position.needsUpdate = true;
    }
    function switchVisualization(type) {
      scene.remove(particles, waves, sphere, tunnel);
      currentVisualization = type;
      switch (type) {
        case 'particles': scene.add(particles); break; case 'waves': scene.add(waves); break;
        case 'sphere': scene.add(sphere); break; case 'tunnel': scene.add(tunnel); break;
      }
      switchColorScheme(currentColorScheme);
      document.querySelectorAll('.viz-type').forEach(btn => {
        const pressed = btn.dataset.viz === type;
        btn.setAttribute('aria-pressed', pressed);
        btn.classList.toggle('bg-indigo-600', pressed); btn.classList.toggle('bg-gray-700', !pressed);
      });
    }
    function switchColorScheme(scheme) {
      currentColorScheme = scheme;
      const newColor = new THREE.Color(colorSchemes[scheme][0]);
      waves.material.color.set(newColor); sphere.material.color.set(newColor); tunnel.material.color.set(newColor);
      const particleColors = particles.geometry.attributes.color.array;
      for (let i = 0; i < particleColors.length; i += 3) {
        particleColors[i] = newColor.r; particleColors[i + 1] = newColor.g; particleColors[i + 2] = newColor.b;
      }
      particles.geometry.attributes.color.needsUpdate = true;
      document.querySelectorAll('.color-scheme').forEach(btn => {
        const pressed = btn.dataset.scheme === scheme;
        btn.setAttribute('aria-pressed', pressed);
        btn.classList.toggle('ring-2', pressed); btn.classList.toggle('ring-white', pressed);
      });
    }
    function adjustVolume(delta) {
        if (!audioElement) return;
        const newVolume = Math.min(1, Math.max(0, audioElement.volume + delta));
        audioElement.volume = newVolume;
        if (volumeSlider) {
          volumeSlider.value = newVolume;
        }
    }

    // --- MODAL ANIMATION HELPERS ---
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      const card  = modal.querySelector('.modal-card');

      modal.classList.remove('hidden');
      modal.style.opacity = 0;
      card.style.opacity  = 0;
      card.style.transform = 'translateY(50px)';

      anime.timeline()
        .add({
          targets: modal,
          opacity: [0,1],
          duration: 200,
          easing: 'linear'
        })
        .add({
          targets: card,
          translateY: [50,0],
          opacity: [0,1],
          duration: 300,
          easing: 'easeOutQuad'
        }, '-=150');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      const card  = modal.querySelector('.modal-card');

      anime.timeline()
        .add({
          targets: card,
          translateY: [0,50],
          opacity: [1,0],
          duration: 200,
          easing: 'easeInQuad'
        })
        .add({
          targets: modal,
          opacity: [1,0],
          duration: 150,
          easing: 'linear'
        }, '-=150')
        .finished.then(() => {
          modal.classList.add('hidden');
        });
    }
    
    function showAlert(message, title = 'Notice') {
      document.getElementById('alertTitle').textContent = title;
      document.getElementById('alertMessage').textContent = message;
      openModal('alertModal');
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('appVersion').textContent = `v${APP_VERSION}`;
      document.getElementById('appCopyright').textContent = `© ${new Date().getFullYear()} AuraSync X. All rights reserved.`;

      specCanvas = document.getElementById('spectrumCanvas');
      specCtx = specCanvas.getContext('2d');
      
      decibelBar   = document.getElementById('decibelBar');
      decibelValue = document.getElementById('decibelValue');

      initThreeJS();
      resizeSpectrumCanvas();
      
      renderPlaylist();
      renderRecommendedStations(); 
      updateButtons();

      currentTimeEl   = document.getElementById('currentTime');
      durationEl      = document.getElementById('durationTime');
      progressWrapper = document.getElementById('progressWrapper');
      progressBar     = document.getElementById('progressBar');
      volumeSlider    = document.getElementById('volumeSlider');
      
      progressWrapper.addEventListener('click', seek);

      volumeSlider.addEventListener('input', e => {
        if (audioElement) {
          audioElement.volume = e.target.value;
        }
      });

      document.querySelectorAll('.viz-type').forEach(btn => btn.addEventListener('click', () => switchVisualization(btn.dataset.viz)));
      document.querySelectorAll('.color-scheme').forEach(btn => btn.addEventListener('click', () => switchColorScheme(btn.dataset.scheme)));
      playPauseBtn.addEventListener('click', togglePlayPause);
      nextBtn.addEventListener('click', playNextTrack);
      prevBtn.addEventListener('click', playPrevTrack);
      fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

      const urlInput  = document.getElementById('urlInput');
      const addUrlBtn = document.getElementById('addUrlBtn');

      addUrlBtn.addEventListener('click', () => {
        const url = urlInput.value.trim();
        if (!url) return;

        if (!/^https?:\/\/.+\.(mp3|ogg|wav)(\?.*)?$/i.test(url)) {
          showAlert('Please enter a direct link to an audio file (mp3/ogg/wav).', 'Invalid URL');
          return;
        }

        const filename = url.split('/').pop().split('?')[0];
        playlist.push({
          file:   null,
          url,
          name:  decodeURIComponent(filename),    
          artist:'Remote URL',
          isDefault: false,
          type: 'remote'
        });

        renderPlaylist();
        updateButtons();
        urlInput.value = '';
      });

      /* ====== INTERNET-RADIO SUPPORT ====== */
      async function fetchStationByName(name) {
        const endpoint = `https://de1.api.radio-browser.info/json/stations/byname/${encodeURIComponent(name)}`;
        try {
          const response = await fetch(endpoint);
          if (!response.ok) throw new Error(`API responded with ${response.status}`);
          const stations  = await response.json();
          return stations.find(s => s.url_resolved) || null;
        } catch (err) {
          console.error('Radio-Browser API error:', err);
          showAlert('Could not connect to the radio station directory. Please try again later.', 'Network Error');
          return null;
        }
      }

      document.getElementById('radioSearchBtn').addEventListener('click', async () => {
        const input = document.getElementById('radioSearchInput');
        const query = input.value.trim();
        if (!query) return;

        const station = await fetchStationByName(query);
        if (!station) {
          showAlert(`No playable stream found for “${query}”. Please try a different name.`, 'Station Not Found');
          return;
        }

        let url = station.url_resolved || station.url;
        if (url.endsWith('.m3u8') && station.url) {
          url = station.url;
        }

        playlist.push({
          file: null,
          url:  url,
          name: station.name || query,
          artist: station.country || 'Internet Radio',
          isDefault: false,
          type: 'radio'
        });

        renderPlaylist();
        updateButtons();
        input.value = '';
      });
      /* ====== end internet-radio support ====== */

      const speedSlider = document.getElementById('speed');
      const sensitivitySlider = document.getElementById('sensitivity');
      speedSlider.addEventListener('input', (e) => {
          animationSpeed = e.target.value;
          e.target.setAttribute('aria-valuenow', e.target.value);
      });
      sensitivitySlider.addEventListener('input', (e) => {
          sensitivity = e.target.value;
          e.target.setAttribute('aria-valuenow', e.target.value);
      });

      function setSidebarVisibility(visible) {
        togglePlaylistBtn.setAttribute('aria-expanded', visible);
        if (visible) {
            playlistPanel.classList.remove('translate-x-full');
            mainContent.classList.add('lg:pr-80');
            playlistToggleIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />`;
        } else {
            playlistPanel.classList.add('translate-x-full');
            mainContent.classList.remove('lg:pr-80');
            playlistToggleIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>`;
        }
      }

      togglePlaylistBtn.addEventListener('click', () => {
          const isCurrentlyHidden = playlistPanel.classList.contains('translate-x-full');
          setSidebarVisibility(isCurrentlyHidden);
      });

      closePlaylistBtn.addEventListener('click', () => {
          setSidebarVisibility(false);
      });

      // === PAGINATION TABS ===
      document.querySelectorAll('.playlist-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          currentLayer = btn.dataset.layer; 

          document.querySelectorAll('.playlist-tab').forEach(b => {
            const isThis = b === btn;
            b.classList.toggle('bg-indigo-600',    isThis);
            b.classList.toggle('font-semibold',     isThis);
            b.classList.toggle('bg-gray-700',      !isThis);
            b.classList.toggle('hover:bg-indigo-500', !isThis);
          });

          renderPlaylist();
        });
      });

      // === MODAL EVENT LISTENERS ===
      document.getElementById('accessibilityBtn').addEventListener('click', () => openModal('accessibilityModal'));
      document.getElementById('closeAccessibility').addEventListener('click', () => closeModal('accessibilityModal'));
      document.getElementById('helpBtn').addEventListener('click', () => openModal('helpModal'));
      document.getElementById('closeHelp').addEventListener('click', () => closeModal('helpModal'));
      document.getElementById('closeAlert').addEventListener('click', () => closeModal('alertModal'));
      
      document.getElementById('highContrast').addEventListener('change', e => document.body.classList.toggle('high-contrast', e.target.checked));

      document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT' || e.target.isContentEditable) return;
        switch (e.key) {
          case ' ': e.preventDefault(); togglePlayPause(); break;
          case 'ArrowRight': e.preventDefault(); playNextTrack(); break;
          case 'ArrowLeft': e.preventDefault(); playPrevTrack(); break;
          case '+': case '=': e.preventDefault(); adjustVolume(0.1); break;
          case '-': e.preventDefault(); adjustVolume(-0.1); break;
        }
      });

      switchVisualization('particles');
      switchColorScheme('blue');
      
      anime({ 
        targets: '.container > *',
        translateY: [20, 0], 
        opacity: [0, 1], 
        delay: anime.stagger(100), 
        easing: 'easeOutQuad' 
      });
      
      // --- Initialize Tippy.js Tooltips ---
      tippy('[data-tippy-content]', {
        theme: 'material',
        animation: 'shift-away-subtle',
        delay: [150, 0],
      });
    });
  </script>
</body>
</html>
